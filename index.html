<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Load non-critical CSS asynchronously -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" media="print" onload="this.media='all'">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <noscript>
        <!-- Fallback for users without JavaScript -->
        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    </noscript>

    <style>
        /* Inline critical CSS */
        #map_81cd338698166bd49ae6f1c905363c85 {
            position: relative;
            width: 850px;
            height: 600px;
            margin: 0 auto;
            left: 0.0%;
            top: 0.0%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .leaflet-container { font-size: 1rem; }
        
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #0d1117;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        #map {
            position:absolute;
            top:0;
            bottom:0;
            right:0;
            left:0;
        }
        
        .foliumtooltip {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .foliumtooltip table{
            margin: auto;
        }
        .foliumtooltip tr{
            text-align: left;
        }
        .foliumtooltip th{
            padding: 2px; padding-right: 8px;
        }
        
        .header {
            padding: 20px 40px;
            background-color: #0d1117;
        }
        
        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 2.5em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            letter-spacing: -0.5px;
        }
        
        .header p {
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            margin-top: 5px;
            color: #aaa;
            letter-spacing: 0.3px;
        }
        
        /* Loading indicator */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header section -->
    <div class="header">
        <h1>Coffee Map Visualizer</h1>
        <p>Costa Rica</p>
    </div>
    
    
    <!-- Loading indicator -->
    <div class="map-loading" id="mapLoading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading map data...</p>
    </div>
    
    <div class="folium-map" id="map_81cd338698166bd49ae6f1c905363c85"></div>
    
    <!-- Download Button -->
    <div style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
        <button id="downloadLayerBtn" class="btn btn-primary" style="background-color: #2c3e50; border: none; font-family: 'Poppins', sans-serif; padding: 8px 15px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            <i class="fa fa-download"></i> Download Layer
        </button>
    </div>

    <!-- Load scripts with defer attribute -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.0/Control.FullScreen.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.js" defer></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js" defer></script>

    <script>
        // Show loading indicator when page starts loading
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('mapLoading').style.display = 'block';
        });

        // Wait for all resources to load
        window.addEventListener('load', function() {
            // Initialize map after all resources are loaded
            initializeMap();
        });

        function initializeMap() {
            // Your map initialization code goes here
            var map_81cd338698166bd49ae6f1c905363c85 = L.map(
                "map_81cd338698166bd49ae6f1c905363c85",
                {
                    center: [9.7489, -83.7534],
                    crs: L.CRS.EPSG3857,
                    zoom: 8,
                    zoomControl: true,
                    preferCanvas: false,  // Using canvas can improve performance with many elements
                }
            );
            
            // Add scale control
            L.control.scale().addTo(map_81cd338698166bd49ae6f1c905363c85);

            // Add tile layer
            var tile_layer = L.tileLayer(
                "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
                {
                    minZoom: 0,
                    maxZoom: 24,
                    maxNativeZoom: 24,
                    noWrap: false,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: "abcd",
                    detectRetina: false,
                    tms: false,
                    opacity: 1,
                }
            ).addTo(map_81cd338698166bd49ae6f1c905363c85);
            
            // Add fullscreen control
            L.control.fullscreen({
                position: "topleft",
                title: "Full Screen",
                titleCancel: "Exit Full Screen",
                forceSeparateButton: false,
            }).addTo(map_81cd338698166bd49ae6f1c905363c85);
            
            // Draw control
            var drawnItems = new L.featureGroup().addTo(map_81cd338698166bd49ae6f1c905363c85);
            var drawControl = new L.Control.Draw({
                position: "topleft",
                draw: {},
                edit: {
                    featureGroup: drawnItems
                }
            }).addTo(map_81cd338698166bd49ae6f1c905363c85);
            
            map_81cd338698166bd49ae6f1c905363c85.on(L.Draw.Event.CREATED, function(e) {
                var layer = e.layer;
                drawnItems.addLayer(layer);
            });

            // Geocoder control
            L.Control.geocoder({
                collapsed: true,
                position: "topleft",
                defaultMarkGeocode: true,
                zoom: 11,
                provider: "nominatim",
            }).on('markgeocode', function(e) {
                map_81cd338698166bd49ae6f1c905363c85.setView(e.geocode.center, 11);
            }).addTo(map_81cd338698166bd49ae6f1c905363c85);

            // Load GeoJSON data with fetch
            fetch("data/cober_arborea_2021_dissolve_4326.geojson")
                .then(response => response.json())
                .then(data => {
                    // Simplify GeoJSON if it's too large
                    const simplifiedData = simplifyGeoJSON(data);
                    
                    // Create GeoJSON layer with simplified data
                    var geoJsonLayer = L.geoJson(simplifiedData, {
                        style: function(feature) {
                            return {
                                color: "blue",
                                fillColor: "blue",
                                fillOpacity: 0.3,
                                interactive: false,
                                weight: 1
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            layer.on({
                                mouseout: function(e) {
                                    if(typeof e.target.setStyle === "function") {
                                        geoJsonLayer.resetStyle(e.target);
                                    }
                                },
                                mouseover: function(e) {
                                    if(typeof e.target.setStyle === "function") {
                                        e.target.setStyle({
                                            fillOpacity: 0,
                                            weight: 3
                                        });
                                    }
                                },
                            });
                            
                            // Bind tooltip
                            layer.bindTooltip(
                                createTooltip(feature),
                                {sticky: true, className: "foliumtooltip"}
                            );
                        }
                    }).addTo(map_81cd338698166bd49ae6f1c905363c85);
                    
                    // Fit bounds
                    map_81cd338698166bd49ae6f1c905363c85.fitBounds(geoJsonLayer.getBounds());
                    
                    // Add layer control
                    var layerControl = L.control.layers({
                        "CartoDB Positron": tile_layer
                    }, {
                        "Cobertura Arbórea": geoJsonLayer
                    }, {
                        position: "topright",
                        collapsed: true
                    }).addTo(map_81cd338698166bd49ae6f1c905363c85);
                    
                    // Hide loading indicator
                    document.getElementById('mapLoading').style.display = 'none';
                })
                .catch(error => {
                    console.error("Error loading GeoJSON:", error);
                    document.getElementById('mapLoading').style.display = 'none';
                });

            // Download button functionality
            document.getElementById('downloadLayerBtn').addEventListener('click', function() {
                fetch("data/cober_arborea_2021_dissolve_4326.geojson")
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'cobertura_arborea.geojson';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    })
                    .catch(error => console.error("Error downloading the layer:", error));
            });
        }

        // Function to create tooltip content
        function createTooltip(feature) {
            let div = document.createElement('div');
            
            function handleObject(value) {
                if (value === null) {
                    return '';
                } else if (typeof value === 'object') {
                    return JSON.stringify(value);
                } else {
                    return value;
                }
            }
            
            const fields = ["fid", "Codigo"];
            const aliases = ["fid", "Codigo"];
            
            let table = '<table>';
            fields.forEach((field, i) => {
                if (feature.properties[field] !== undefined) {
                    table += `<tr>
                        <th>${aliases[i]}</th>
                        <td>${handleObject(feature.properties[field])}</td>
                    </tr>`;
                }
            });
            table += '</table>';
            
            div.innerHTML = table;
            return div;
        }

        // Function to simplify GeoJSON (reduce precision and remove unnecessary properties)
        function simplifyGeoJSON(data) {
            // If the GeoJSON is very large, consider simplifying it
            // This is a basic implementation - you might want to use a library like
            // turf.js for more advanced simplification
            if (data.features && data.features.length > 1000) {
                console.warn("Large GeoJSON detected. Consider simplifying server-side for better performance.");
                
                // Simple coordinate precision reduction
                data.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.type === "Polygon") {
                        feature.geometry.coordinates = feature.geometry.coordinates.map(ring => {
                            return ring.map(coord => {
                                return [
                                    Math.round(coord[0] * 10000) / 10000,
                                    Math.round(coord[1] * 10000) / 10000
                                ];
                            });
                        });
                    }
                });
            }
            return data;
        }
    </script>
</body>
</html>