import streamlit as st
import leafmap.foliumap as leafmap
import requests

# Correr la aplicación con: streamlit run streamlit_app.py
APP_TITLE = "Cafe Map Visualizer"
APP_SUBTITLE = "Prueba Dashboard"

@st.cache_data
def load_geojson_url():
    """Carga el archivo GeoJSON desde URL con cache para mejorar rendimiento"""
    # URL para el archivo GeoJSON de países (puedes reemplazar con tu URL)
    url = "https://github.com/Brryan12/DashBoard/blob/main/Data/cober_arborea_2021_dissolve_4326.geojson?raw=true"

    try:
        return url
    except Exception as e:
        st.error(f"Error al cargar el GeoJSON desde URL: {str(e)}")
        return None

def display_map():
    try:
        geojson_url = load_geojson_url()
        if geojson_url is None:
            st.error("No se puede cargar el mapa sin el archivo GeoJSON")
            return
        
        # Crear el mapa centrado en Costa Rica
        m = leafmap.Map(center=[9.7489, -83.7534], zoom=4)
        
        # Agregar el GeoJSON desde URL
        m.add_geojson(
            geojson_url,
            layer_name="Países",
            style={
                "color": "blue",
                "weight": 1,
                "fillColor": "green",
                "fillOpacity": 0.3
            },
            hover_style={
                "fillColor": "red",
                "fillOpacity": 0.7
            }
        )
        
        # Mostrar el mapa en Streamlit usando el método to_streamlit()
        m.to_streamlit(height=700)
        
    except Exception as e:
        st.error(f"Error al cargar el mapa: {str(e)}")
        st.info("Revisa la URL del GeoJSON o tu conexión a internet.")

def main():
    st.set_page_config(page_title=APP_TITLE, layout="wide")
    st.title(APP_TITLE)
    st.caption(APP_SUBTITLE)
    
    # Sidebar con información
    st.sidebar.title("Información")
    st.sidebar.info("Visualizador de datos geoespaciales en Streamlit usando leafmap")
    
    # Mostrar mapa
    display_map()

if __name__ == "__main__":
    main()


    ////////////
    import streamlit as st
import leafmap.foliumap as leafmap
import requests
import os

# Establecer límite de tamaño para GeoJSON (0 para sin límite)
os.environ['OGR_GEOJSON_MAX_OBJ_SIZE'] = '0'

# Correr la aplicación con: streamlit run streamlit_app.py
APP_TITLE = "Cafe Map Visualizer"
APP_SUBTITLE = "Prueba Dashboard"

@st.cache_data
def load_geojson_url():
    """Carga el archivo GeoJSON desde URL con cache para mejorar rendimiento"""
    # URL para el archivo GeoJSON
    url = "https://github.com/Brryan12/DashBoard/blob/main/Data/cober_arborea_2021_dissolve_4326.geojson?raw=true"
    return url

def display_map():
    try:
        with st.spinner("Cargando mapa... esto puede tomar un momento para archivos grandes"):
            geojson_url = load_geojson_url()
            
            # Crear el mapa centrado en Costa Rica
            m = leafmap.Map(center=[9.7489, -83.7534], zoom=8)
            
            # Método alternativo para GeoJSON grandes
            try:
                # Agregar el GeoJSON desde URL
                m.add_geojson(
                    geojson_url,
                    layer_name="Cobertura Arbórea",
                    style={
                        "color": "blue",
                        "weight": 1,
                        "fillColor": "green",
                        "fillOpacity": 1
                    },
                    hover_style={
                        "fillColor": "red",
                        "fillOpacity": 0.7
                    }
                )
            except Exception as e:
                st.warning(f"Error al cargar con método estándar: {str(e)}")
                st.info("Intentando método alternativo...")
                
                # Método alternativo usando geopandas si está disponible
                try:
                    import geopandas as gpd
                    
                    # Cargar GeoJSON como GeoDataFrame
                    gdf = gpd.read_file(geojson_url)
                    
                    # Simplificar geometría si es necesario
                    if len(gdf) > 1000:
                        st.info("Simplificando geometría para mejor rendimiento...")
                        gdf = gdf.simplify(tolerance=0.01)
                    
                    # Añadir al mapa
                    m.add_gdf(
                        gdf,
                        layer_name="Cobertura Arbórea (simplificado)",
                        style={"color": "blue", "fillColor": "green", "fillOpacity": 0.3}
                    )
                except ImportError:
                    st.error("No se pudo cargar geopandas. Instálalo con 'pip install geopandas'")
            
            # Mostrar el mapa en Streamlit
            m.to_streamlit(height=700)
        
    except Exception as e:
        st.error(f"Error al cargar el mapa: {str(e)}")
        st.info("""
        El archivo GeoJSON es demasiado grande (>50MB). Recomendaciones:
        1. Usa un GeoJSON más pequeño
        2. Simplifica la geometría con mapshaper.org
        3. Instala geopandas: pip install geopandas
        """)

def main():
    st.set_page_config(page_title=APP_TITLE, layout="wide")
    st.title(APP_TITLE)
    st.caption(APP_SUBTITLE)
    
    # Sidebar con información
    st.sidebar.title("Información")
    st.sidebar.info("Visualizador de datos geoespaciales de cobertura arbórea en Costa Rica")
    
    # Mostrar mapa
    display_map()

if __name__ == "__main__":
    main()